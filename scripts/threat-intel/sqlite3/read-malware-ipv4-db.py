import sqlite3
from datetime import datetime
import sys

def format_unix_timestamp(timestamp):
    if timestamp is not None:
        return datetime.utcfromtimestamp(timestamp).strftime('%Y-%m-%d')
    else:
        return None

def search_ip_in_database(conn, ip):
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM threat_table_by_ip WHERE ip = ?", (ip,))
    result = cursor.fetchone()
    return result

def main(inputFilename, ipAddress):

    sqlite_filename = inputFilename

    conn = sqlite3.connect(sqlite_filename)

    result = search_ip_in_database(conn, ipAddress)

    if result:
        print("Results:")
        print("\tIP:", result[0])
        print("\tThreat Type:", result[1])
        print("\tFirst Seen:", format_unix_timestamp(result[2]))
        print("\tLast Seen:", format_unix_timestamp(result[3]))
    else:
        print(f"\tIP {ipAddress} not found in the database.")

    conn.close()

if __name__ == "__main__":

    inputFilename = sys.argv[1]
    ipAddress = sys.argv[2]

    print("\nFind IP by WHOIS.  input arguments: <ipv4.csv file> <ip_address>\n")

    main(inputFilename, ipAddress)
