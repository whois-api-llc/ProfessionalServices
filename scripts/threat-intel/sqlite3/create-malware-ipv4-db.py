import csv
import sqlite3
import sys

def create_table(cursor):
    cursor.execute('''CREATE TABLE IF NOT EXISTS threat_table_by_ip (
                        ip TEXT PRIMARY KEY,
                        threatType TEXT,
                        firstSeen INTEGER,
                        lastSeen INTEGER
                    )''')

def insert_data(cursor, row):
    cursor.execute('''INSERT OR IGNORE INTO threat_table_by_ip (ip, threatType, firstSeen, lastSeen)
                      VALUES (?, ?, ?, ?)''', row)

def read_csv_and_insert_into_sqlite(csv_filename, sqlite_filename):

    conn = sqlite3.connect(sqlite_filename)
    cursor = conn.cursor()

    create_table(cursor)

    print("ETL Process Started...")

    with open(csv_filename, 'r') as csv_file:
        csv_reader = csv.reader(csv_file)
        next(csv_reader, None)
        
        for row in csv_reader:
            row[2] = int(row[2]) if row[2].isdigit() else None
            row[3] = int(row[3]) if row[3].isdigit() else None
            insert_data(cursor, row)

    # Commit and close
    conn.commit()
    conn.close()

    print("ETL Process Complete.")

print("\nLOADIPv4 by WHOIS.  ETL: <input_csv_filename> <database_filename.db>")
print("\tThis may take a few minutes depending on your system.\n")

read_csv_and_insert_into_sqlite(sys.argv[1], sys.argv[2])
